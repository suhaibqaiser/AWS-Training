{"version":3,"sources":["../src/app.js"],"names":["os","require","WebSocket","http","url","axios","v4","uuidv4","randomInt","port","process","env","WS_PORT","apiServer","CLIENTS_API","bearerToken","server","createServer","ws","Server","noServer","on","upgrade","request","socket","head","pathname","parse","handleUpgrade","done","wsws","emit","isAlive","put","clientName","clientIp","remoteAddress","clientHostname","clientDeviceId","clientIsAlive","headers","then","res","console","log","status","clientId","data","client","_id","catch","error","heartbeat","post","close","clearInterval","interval","String","incoming","message","send","Date","hostname","write","destroy","noop","setInterval","ping","clients","forEach","each","terminate","listen"],"mappings":"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","sourcesContent":["// requires for libraries\nconst os = require(\"os\");\nconst WebSocket = require('ws');\nconst http = require('http');\nconst url = require('url');\nconst axios = require('axios');\nconst { v4: uuidv4 } = require('uuid');\nconst { randomInt } = require(\"crypto\");\n\n// application constants\nconst port = process.env.WS_PORT || 6380;\nconst apiServer = process.env.CLIENTS_API || 'http://localhost:3000/client/'\nconst bearerToken = 'ea2d3aeaad77865f9769974a920892f5'\n\n// application initialization\nconst server = http.createServer();\nconst ws = new WebSocket.Server({ noServer: true });\n\n\n// request router\nserver.on('upgrade', function upgrade(request, socket, head) {\n    const pathname = url.parse(request.url).pathname;\n\n    if (pathname === '/comms') {\n        ws.handleUpgrade(request, socket, head, function done(wsws) {\n            ws.emit('connection', wsws, request);\n\n            wsws.isAlive = true;\n            //console.log('Client connected ');\n            axios\n                .put(apiServer + 'register', {\n                    clientName: randomInt(99999),\n                    clientIp: request.socket.remoteAddress,\n                    clientHostname: uuidv4(),\n                    clientDeviceId: uuidv4(),\n                    clientIsAlive: true\n                }, {\n                    headers: {\n                        'Authorization': 'Bearer ' + bearerToken\n                    }\n                }).then(res => {\n                    console.log('statusCode :' + res.status)\n                    //console.log(res.data.client)\n                    wsws.clientId = res.data.client._id;\n                    wsws.clientName = res.data.client.clientName;\n                    wsws.clientIp = res.data.client.clientIp;\n                    wsws.clientHostname = res.data.client.clientHostname;\n                    wsws.clientDeviceId = res.data.client.clientDeviceId;\n                }).catch(error => {\n                    console.error(error)\n                })\n            wsws.on('pong', function heartbeat() {\n                this.isAlive = true;\n                axios\n                    .post(apiServer + 'alive', {\n                        clientId: wsws.clientId\n                    }, {\n                        headers: {\n                            'Authorization': 'Bearer ' + bearerToken\n                        }\n                    }).then(res => {\n                        console.log('statusCode :' + res.status)\n                        //console.log(res.data)\n                    }).catch(error => {\n                        console.error(error)\n                    })\n                //console.log('Client online...');\n            });\n\n            wsws.on('close', function close() {\n                //console.log('Client disconnected!');\n                axios\n                    .post(apiServer + 'update', {\n                        clientId: wsws.clientId,\n                        clientName: wsws.clientName,\n                        clientIp: wsws.clientIp,\n                        clientHostname: wsws.clientHostname,\n                        clientDeviceId: wsws.clientDeviceId,\n                        clientIsAlive: false\n                    }, {\n                        headers: {\n                            'Authorization': 'Bearer ' + bearerToken\n                        }\n                    }).then(res => {\n                        console.log('statusCode :' + res.status)\n                        //console.log(res.data)\n                    }).catch(error => {\n                        console.error(error)\n                    })\n                clearInterval(interval);\n            }); String\n\n            wsws.on('message', function incoming(message) {\n                //console.log('Received Message:', message);\n                wsws.send(Date() + ' | Message received at ' + os.hostname + ': ' + message);\n            });\n        });\n    } else {\n        socket.write('HTTP/1.1 401 Unauthorized\\r\\n\\r\\n');\n        socket.destroy();\n    }\n\n    function noop() {\n\n    }\n    const interval = setInterval(function ping() {\n        ws.clients.forEach(function each(wsws) {\n            if (wsws.isAlive === false) {\n                return wsws.terminate();\n            } else {\n                wsws.isAlive = false;\n                wsws.ping(noop);\n            }\n        });\n    }, 30000);\n\n});\nserver.listen(port);\nconsole.log('Websocket server started on port : ' + port);"],"file":"app.js"}