{"version":3,"sources":["../src/app.js"],"names":["os","require","WebSocket","http","url","axios","v4","uuidv4","randomInt","port","process","env","WS_PORT","apiServer","CLIENTS_API","bearerToken","server","createServer","ws","Server","noServer","on","upgrade","request","socket","head","pathname","parse","handleUpgrade","done","wsws","emit","isAlive","put","clientName","clientIp","remoteAddress","clientHostname","clientDeviceId","clientIsAlive","headers","then","res","console","log","status","clientId","data","client","_id","catch","error","heartbeat","post","close","clearInterval","interval","String","incoming","message","send","Date","hostname","write","destroy","noop","setInterval","ping","clients","forEach","each","terminate","listen"],"mappings":"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","sourcesContent":["// requires for libraries\r\nconst os = require(\"os\");\r\nconst WebSocket = require('ws');\r\nconst http = require('http');\r\nconst url = require('url');\r\nconst axios = require('axios');\r\nconst { v4: uuidv4 } = require('uuid');\r\nconst { randomInt } = require(\"crypto\");\r\n\r\n// application constants\r\nconst port = process.env.WS_PORT || 6380;\r\nconst apiServer = process.env.CLIENTS_API || 'http://localhost:3000/client/'\r\nconst bearerToken = 'ea2d3aeaad77865f9769974a920892f5'\r\n\r\n// application initialization\r\nconst server = http.createServer();\r\nconst ws = new WebSocket.Server({ noServer: true });\r\n\r\n\r\n// request router\r\nserver.on('upgrade', function upgrade(request, socket, head) {\r\n    const pathname = url.parse(request.url).pathname;\r\n\r\n    if (pathname === '/comms') {\r\n        ws.handleUpgrade(request, socket, head, function done(wsws) {\r\n            ws.emit('connection', wsws, request);\r\n\r\n            wsws.isAlive = true;\r\n            //console.log('Client connected ');\r\n            axios\r\n                .put(apiServer + 'register', {\r\n                    clientName: randomInt(99999),\r\n                    clientIp: request.socket.remoteAddress,\r\n                    clientHostname: uuidv4(),\r\n                    clientDeviceId: uuidv4(),\r\n                    clientIsAlive: true\r\n                }, {\r\n                    headers: {\r\n                        'Authorization': 'Bearer ' + bearerToken\r\n                    }\r\n                }).then(res => {\r\n                    console.log('statusCode :' + res.status)\r\n                    //console.log(res.data.client)\r\n                    wsws.clientId = res.data.client._id;\r\n                    wsws.clientName = res.data.client.clientName;\r\n                    wsws.clientIp = res.data.client.clientIp;\r\n                    wsws.clientHostname = res.data.client.clientHostname;\r\n                    wsws.clientDeviceId = res.data.client.clientDeviceId;\r\n                }).catch(error => {\r\n                    console.error(error)\r\n                })\r\n            wsws.on('pong', function heartbeat() {\r\n                this.isAlive = true;\r\n                axios\r\n                    .post(apiServer + 'alive', {\r\n                        clientId: wsws.clientId\r\n                    }, {\r\n                        headers: {\r\n                            'Authorization': 'Bearer ' + bearerToken\r\n                        }\r\n                    }).then(res => {\r\n                        console.log('statusCode :' + res.status)\r\n                        //console.log(res.data)\r\n                    }).catch(error => {\r\n                        console.error(error)\r\n                    })\r\n                //console.log('Client online...');\r\n            });\r\n\r\n            wsws.on('close', function close() {\r\n                //console.log('Client disconnected!');\r\n                axios\r\n                    .post(apiServer + 'update', {\r\n                        clientId: wsws.clientId,\r\n                        clientName: wsws.clientName,\r\n                        clientIp: wsws.clientIp,\r\n                        clientHostname: wsws.clientHostname,\r\n                        clientDeviceId: wsws.clientDeviceId,\r\n                        clientIsAlive: false\r\n                    }, {\r\n                        headers: {\r\n                            'Authorization': 'Bearer ' + bearerToken\r\n                        }\r\n                    }).then(res => {\r\n                        console.log('statusCode :' + res.status)\r\n                        //console.log(res.data)\r\n                    }).catch(error => {\r\n                        console.error(error)\r\n                    })\r\n                clearInterval(interval);\r\n            }); String\r\n\r\n            wsws.on('message', function incoming(message) {\r\n                //console.log('Received Message:', message);\r\n                wsws.send(Date() + ' | Message received at ' + os.hostname + ': ' + message);\r\n            });\r\n        });\r\n    } else {\r\n        socket.write('HTTP/1.1 401 Unauthorized\\r\\n\\r\\n');\r\n        socket.destroy();\r\n    }\r\n\r\n    function noop() {\r\n\r\n    }\r\n    const interval = setInterval(function ping() {\r\n        ws.clients.forEach(function each(wsws) {\r\n            if (wsws.isAlive === false) {\r\n                return wsws.terminate();\r\n            } else {\r\n                wsws.isAlive = false;\r\n                wsws.ping(noop);\r\n            }\r\n        });\r\n    }, 30000);\r\n\r\n});\r\nserver.listen(port);\r\nconsole.log('Websocket server started on port : ' + port);"],"file":"app.js"}